# Конфигурация HAProxy для Задания 2
# Взвешенная балансировка нагрузки на 7-м уровне (HTTP) с маршрутизацией по домену

global
    # Запуск в режиме демона
    daemon
    
    # Настройка логирования
    log stdout local0 info
    
    # Пользователь и группа для запуска HAProxy
    # user haproxy
    # group haproxy
    
    # Максимальное количество соединений
    maxconn 4096

defaults
    # Режим работы - HTTP (7-й уровень)
    mode http
    
    # Настройки таймаутов
    timeout connect 5000ms    # Таймаут подключения к backend
    timeout client 50000ms   # Таймаут клиентского соединения
    timeout server 50000ms   # Таймаут серверного соединения
    
    # Наследование настроек логирования
    log global
    
    # Опции HTTP логирования
    option httplog
    option dontlognull
    
    # Максимальное количество соединений
    maxconn 3000
    
    # Опции HTTP
    option http-server-close
    option forwardfor

# Frontend - точка входа для HTTP-запросов
frontend http_frontend
    # Привязка к порту 8090 на всех интерфейсах
    bind *:8090
    
    # ACL для проверки заголовка Host
    # Проверяем, что запрос идет к домену example.local
    acl is_example_local hdr(host) -i example.local
    
    # Маршрутизация на основе ACL
    use_backend http_backend if is_example_local
    
    # Backend по умолчанию для всех остальных запросов
    default_backend default_backend
    
    # Захват заголовков для логирования
    capture request header Host len 32
    capture request header User-Agent len 64

# Backend для домена example.local с взвешенной балансировкой
backend http_backend
    # Алгоритм балансировки - weighted round-robin
    balance roundrobin
    
    # Настройки проверки здоровья серверов
    option httpchk GET /
    http-check expect status 200
    
    # Определение серверов с весами
    # Веса: сервер1=2, сервер2=3, сервер3=4
    server server1 127.0.0.1:8001 check weight 2 inter 2000ms rise 2 fall 3
    server server2 127.0.0.1:8002 check weight 3 inter 2000ms rise 2 fall 3
    server server3 127.0.0.1:8003 check weight 4 inter 2000ms rise 2 fall 3
    
    # Описание опций:
    # weight X - вес сервера для взвешенной балансировки
    # check - включить проверку здоровья сервера
    # inter 2000ms - интервал проверки здоровья (2 секунды)
    # rise 2 - количество успешных проверок для восстановления сервера
    # fall 3 - количество неудачных проверок для исключения сервера

# Backend по умолчанию - отклоняет все запросы не к example.local
backend default_backend
    # Возвращаем ошибку 403 для всех запросов
    http-request deny deny_status 403
    
    # Альтернативно можно вернуть кастомную страницу:
    # http-request return status 403 content-type text/html string "<html><body><h1>403 Forbidden</h1><p>Доступ разрешен только для домена example.local</p></body></html>"

# Статистика HAProxy
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:password
    stats show-legends
