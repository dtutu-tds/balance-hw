# Конфигурация HAProxy для Задания 1
# Балансировка нагрузки Round-Robin на 4-м уровне (TCP)

global
    # Запуск в режиме демона
    daemon
    
    # Настройка логирования
    log stdout local0 info
    
    # Пользователь и группа для запуска HAProxy
    # user haproxy
    # group haproxy
    
    # Максимальное количество соединений
    maxconn 4096

defaults
    # Режим работы - TCP (4-й уровень)
    mode tcp
    
    # Настройки таймаутов
    timeout connect 5000ms    # Таймаут подключения к backend
    timeout client 50000ms   # Таймаут клиентского соединения
    timeout server 50000ms   # Таймаут серверного соединения
    
    # Наследование настроек логирования
    log global
    
    # Опции логирования
    option tcplog
    
    # Максимальное количество соединений
    maxconn 3000

# Frontend - точка входа для клиентских соединений
frontend tcp_frontend
    # Привязка к порту 8090 на всех интерфейсах
    bind *:8090
    
    # Использование backend по умолчанию
    default_backend tcp_backend
    
    # Логирование всех соединений
    capture request header Host len 32

# Backend - группа серверов для обработки запросов
backend tcp_backend
    # Алгоритм балансировки - round-robin
    balance roundrobin
    
    # Настройки проверки здоровья серверов
    option tcp-check
    
    # Определение серверов
    # server <имя> <адрес:порт> <опции>
    server server1 127.0.0.1:8001 check inter 2000ms rise 2 fall 3
    server server2 127.0.0.1:8002 check inter 2000ms rise 2 fall 3
    
    # Описание опций:
    # check - включить проверку здоровья сервера
    # inter 2000ms - интервал проверки здоровья (2 секунды)
    # rise 2 - количество успешных проверок для восстановления сервера
    # fall 3 - количество неудачных проверок для исключения сервера

# Статистика HAProxy (опционально)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:password
