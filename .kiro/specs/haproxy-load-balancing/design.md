# Документ проектирования

## Обзор

Система балансировки нагрузки HAProxy состоит из следующих компонентов:
- Несколько простых HTTP-серверов Python в качестве backend-серверов
- HAProxy в качестве load balancer с двумя различными конфигурациями
- Скрипты для тестирования и мониторинга балансировки нагрузки
- Документация и скриншоты для демонстрации работы

## Архитектура

### Задание 1: Балансировка Round-Robin на 4-м уровне
```
Клиент → HAProxy (порт 8080) → Backend серверы
                                ├── Python сервер 1 (порт 8001)
                                └── Python сервер 2 (порт 8002)
```

### Задание 2: Взвешенная балансировка на 7-м уровне
```
Клиент → HAProxy (порт 8080) → Backend серверы (только для example.local)
                                ├── Python сервер 1 (порт 8001, вес 2)
                                ├── Python сервер 2 (порт 8002, вес 3)
                                └── Python сервер 3 (порт 8003, вес 4)
```

## Компоненты и интерфейсы

### 1. Python HTTP серверы
- **Назначение**: Простые веб-серверы для демонстрации балансировки
- **Технология**: Python встроенный модуль `http.server`
- **Порты**: 8001, 8002, 8003
- **Функциональность**: 
  - Отвечают на HTTP-запросы
  - Показывают информацию о сервере (порт, время запроса)
  - Логируют входящие запросы

### 2. HAProxy Load Balancer
- **Назначение**: Распределение нагрузки между backend-серверами
- **Порт**: 8080 (frontend)
- **Конфигурации**:
  - **Задание 1**: TCP режим, алгоритм roundrobin
  - **Задание 2**: HTTP режим, алгоритм weighted roundrobin с ACL для домена

### 3. Скрипты тестирования
- **Назначение**: Автоматизация тестирования балансировки
- **Функциональность**:
  - Запуск/остановка серверов
  - Выполнение тестовых запросов
  - Сбор статистики распределения

## Модели данных

### Конфигурация HAProxy для Задания 1
```haproxy
global
    daemon
    log stdout local0

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    log global

frontend tcp_frontend
    bind *:8080
    default_backend tcp_backend

backend tcp_backend
    balance roundrobin
    server server1 127.0.0.1:8001 check
    server server2 127.0.0.1:8002 check
```

### Конфигурация HAProxy для Задания 2
```haproxy
global
    daemon
    log stdout local0

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    log global

frontend http_frontend
    bind *:8080
    acl is_example_local hdr(host) -i example.local
    use_backend http_backend if is_example_local
    default_backend default_backend

backend http_backend
    balance roundrobin
    server server1 127.0.0.1:8001 check weight 2
    server server2 127.0.0.1:8002 check weight 3
    server server3 127.0.0.1:8003 check weight 4

backend default_backend
    http-request deny
```

### Структура Python сервера
```python
# Простой HTTP сервер с логированием
import http.server
import socketserver
import datetime

class CustomHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        # Логирование запроса
        # Возврат информации о сервере
        # Отображение времени запроса
```

## Обработка ошибок

### Сценарии ошибок
1. **Недоступность backend-сервера**
   - HAProxy автоматически исключает недоступные серверы
   - Health checks для мониторинга состояния серверов

2. **Неправильная конфигурация HAProxy**
   - Валидация конфигурации перед запуском
   - Подробные логи для диагностики

3. **Проблемы с портами**
   - Проверка доступности портов перед запуском
   - Graceful shutdown серверов

### Логирование
- HAProxy логи для отслеживания запросов
- Python серверы логируют все входящие запросы
- Timestamp для каждого запроса

## Стратегия тестирования

### Функциональное тестирование
1. **Тест балансировки Round-Robin**
   - Выполнение серии запросов к HAProxy
   - Проверка чередования ответов от разных серверов
   - Скриншоты результатов

2. **Тест взвешенной балансировки**
   - Выполнение большого количества запросов
   - Анализ распределения по весам (2:3:4)
   - Статистический анализ результатов

3. **Тест маршрутизации по домену**
   - Запросы с заголовком Host: example.local
   - Запросы без специального заголовка
   - Проверка правильной маршрутизации

### Инструменты тестирования
- `curl` для HTTP-запросов
- `ab` (Apache Bench) для нагрузочного тестирования
- Скрипты на bash/python для автоматизации
- Скриншоты браузера для документации

### Метрики для измерения
- Количество запросов на каждый сервер
- Время ответа серверов
- Успешность health checks
- Соответствие весовому распределению

## Развертывание

### Требования к системе
- Ubuntu Linux
- Python 3.x
- HAProxy 2.x
- curl для тестирования

### Последовательность развертывания
1. Установка HAProxy
2. Создание конфигурационных файлов
3. Создание Python серверов
4. Запуск серверов в правильном порядке
5. Тестирование конфигураций
6. Документирование результатов